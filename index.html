<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Copa Patota - Apostas</title>
  <link rel="stylesheet" href="estilos.css" /> <!-- seu CSS externo -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <div id="login-container" style="text-align:center; margin-top: 3rem;">
    <button onclick="fazerLoginGoogle()">Entrar com Google</button>
  </div>

  <div class="container" style="display:none; max-width: 900px; margin: auto; padding: 1rem;">
    <h1>Copa Patota - Apostas</h1>

    <section>
      <h2>Votação Final</h2>
      <p>
        <button onclick="votarFinal('cfc')">Votar CFC</button>
        <button onclick="votarFinal('estressados')">Votar Estressados</button>
        <button onclick="votarFinal('chupisco')">Votar Chupisco FC</button>
        <button onclick="votarFinal('monobola')">Votar Monobola RFC</button>
      </p>
      <p>
        CFC: <span id="final-cfc">0</span> |
        Estressados: <span id="final-estressados">0</span> |
        Chupisco FC: <span id="final-chupisco">0</span> |
        Monobola RFC: <span id="final-monobola">0</span>
      </p>
      <canvas id="graficoFinal" style="max-width:400px;"></canvas>
    </section>

    <hr/>

    <section>
      <h2>Apostas Múltiplas</h2>
      <form id="form-multipla">
        <label>Nome: <input type="text" id="apostador" required /></label><br/><br/>
        
        <label>Jogo 1 (CFC x Monobolas):</label><br/>
        <input type="radio" name="jogo1" value="cfc" required /> CFC
        <input type="radio" name="jogo1" value="monobolas" /> Monobolas
        <br/><br/>

        <label>Jogo 2 (Chupiscos x Estressados):</label><br/>
        <input type="radio" name="jogo2" value="chupiscos" required /> Chupiscos
        <input type="radio" name="jogo2" value="estressados" /> Estressados
        <br/><br/>

        <label>Jogo 3 (CFC x Estressados):</label><br/>
        <input type="radio" name="jogo3" value="cfc" required /> CFC
        <input type="radio" name="jogo3" value="estressados" /> Estressados
        <br/><br/>

        <label>Jogo 4 (Chupiscos x Monobolas):</label><br/>
        <input type="radio" name="jogo4" value="chupiscos" required /> Chupiscos
        <input type="radio" name="jogo4" value="monobolas" /> Monobolas
        <br/><br/>

        <label>Jogo 5 (Chupiscos x CFC):</label><br/>
        <input type="radio" name="jogo5" value="chupiscos" required /> Chupiscos
        <input type="radio" name="jogo5" value="cfc" /> CFC
        <br/><br/>

        <label>Jogo 6 (Monobolas x Estressados):</label><br/>
        <input type="radio" name="jogo6" value="monobolas" required /> Monobolas
        <input type="radio" name="jogo6" value="estressados" /> Estressados
        <br/><br/>

        <button type="submit">Enviar Aposta</button>
      </form>

      <div id="resultado-multipla" style="margin-top:1rem; font-weight:bold;"></div>

      <h3>Gráficos das Apostas Múltiplas</h3>

      <div style="display:flex; flex-wrap: wrap; gap: 2rem;">
        <div>
          <p>Jogo 1: CFC x Monobolas</p>
          <canvas id="grafico-jogo1" style="max-width:250px;"></canvas>
        </div>
        <div>
          <p>Jogo 2: Chupiscos x Estressados</p>
          <canvas id="grafico-jogo2" style="max-width:250px;"></canvas>
        </div>
        <div>
          <p>Jogo 3: CFC x Estressados</p>
          <canvas id="grafico-jogo3" style="max-width:250px;"></canvas>
        </div>
        <div>
          <p>Jogo 4: Chupiscos x Monobolas</p>
          <canvas id="grafico-jogo4" style="max-width:250px;"></canvas>
        </div>
        <div>
          <p>Jogo 5: Chupiscos x CFC</p>
          <canvas id="grafico-jogo5" style="max-width:250px;"></canvas>
        </div>
        <div>
          <p>Jogo 6: Monobolas x Estressados</p>
          <canvas id="grafico-jogo6" style="max-width:250px;"></canvas>
        </div>
      </div>
    </section>

  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAPSO_BV6U0l2uJ9xdGtTg1CjQhUbUYv9Q",
      authDomain: "copapatota.firebaseapp.com",
      databaseURL: "https://copapatota-default-rtdb.firebaseio.com",
      projectId: "copapatota",
      storageBucket: "copapatota.appspot.com",
      messagingSenderId: "916525284122",
      appId: "1:916525284122:web:b03f134cdd375d3436caa3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    window.fazerLoginGoogle = function () {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          console.log("Login bem-sucedido:", result.user.displayName);
          document.getElementById("login-container").style.display = "none";
          document.querySelector(".container").style.display = "block";
        })
        .catch(error => {
          console.error("Erro ao fazer login:", error);
          alert("Erro ao fazer login: " + error.message);
        });
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("login-container").style.display = "none";
        document.querySelector(".container").style.display = "block";
      }
    });

    // Gráfico da final
    const graficoPizza = new Chart(document.getElementById('graficoFinal'), {
      type: 'pie',
      data: {
        labels: ['CFC', 'Estressados', 'Chupisco FC', 'Monobola RFC'],
        datasets: [{
          data: [0, 0, 0, 0],
          backgroundColor: ['#1f2c5c', '#e74c3c', '#7f8c8d', '#000000']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });

    function atualizarGraficoPizza(dados) {
      graficoPizza.data.datasets[0].data = [
        dados.cfc || 0,
        dados.estressados || 0,
        dados.chupisco || 0,
        dados.monobola || 0
      ];
      graficoPizza.update();
    }

    function atualizarVotos() {
      db.ref('votacaoFinal').on('value', snap => {
        const d = snap.val() || {};
        document.getElementById("final-cfc").textContent = d.cfc || 0;
        document.getElementById("final-estressados").textContent = d.estressados || 0;
        document.getElementById("final-chupisco").textContent = d.chupisco || 0;
        document.getElementById("final-monobola").textContent = d.monobola || 0;
        atualizarGraficoPizza(d);
      });
    }

    atualizarVotos();

    function votarFinal(time) {
      const user = firebase.auth().currentUser;
      if (!user) return alert("Você precisa estar logado para votar.");

      const ref = db.ref('usuariosVotaramFinal/' + user.uid);
      ref.once('value').then(snap => {
        if (snap.exists()) {
          alert("Você já votou na final!");
        } else {
          ref.set(true);
          db.ref('votacaoFinal/' + time).transaction(v => (v || 0) + 1);
          alert("Voto registrado!");
        }
      });
    }

    // Gráficos dos jogos
    const graficosJogos = {};
    const nomesJogos = [
      ['cfc', 'monobolas'],
      ['chupiscos', 'estressados'],
      ['cfc', 'estressados'],
      ['chupiscos', 'monobolas'],
      ['chupiscos', 'cfc'],
      ['monobolas', 'estressados']
    ];

    const coresTimes = {
      cfc: '#1f2c5c',
      estressados: '#e74c3c',
      chupiscos: '#7f8c8d',
      monobolas: '#000000'
    };

    nomesJogos.forEach((times, i) => {
      const idCanvas = `grafico-jogo${i + 1}`;
      const ctx = document.getElementById(idCanvas).getContext('2d');
      const jogoKey = `jogo${i + 1}`;

      graficosJogos[jogoKey] = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: times,
          datasets: [{
            data: [0, 0],
            backgroundColor: times.map(t => coresTimes[t])
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      db.ref('apostasMultiplas').on('value', snap => {
        const apostas = snap.val() || {};
        let contagem = { [times[0]]: 0, [times[1]]: 0 };
        Object.values(apostas).forEach(ap => {
          if (ap[jogoKey] === times[0]) contagem[times[0]]++;
          if (ap[jogoKey] === times[1]) contagem[times[1]]++;
        });
        graficosJogos[jogoKey].data.datasets[0].data = [contagem[times[0]], contagem[times[1]]];
        graficosJogos[jogoKey].update();
      });
    });

    // Formulário múltipla
    document.getElementById("form-multipla").addEventListener("submit", function(e) {
      e.preventDefault();
      const nome = document.getElementById("apostador").value.trim();
      if (!nome) return alert("Digite seu nome!");

      const formData = new FormData(this);
      const aposta = { nome };
      formData.forEach((value, key) => { aposta[key] = value });

      db.ref("apostasMultiplas/" + Date.now()).set(aposta);
      document.getElementById("resultado-multipla").innerText = `Aposta registrada para ${nome}!`;
      this.reset();
      document.getElementById("apostador").value = "";
    });
  </script>
</body>
</html>
